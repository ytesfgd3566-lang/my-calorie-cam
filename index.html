<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡è·¯é‡Œè¯†åˆ« (è¯Šæ–­ç‰ˆ)</title>
    <style>
        body { padding: 20px; font-family: sans-serif; background: #fffaf0; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee; }
        input, button { width: 100%; padding: 15px; margin-top: 10px; box-sizing: border-box; border-radius: 8px; font-size: 16px; }
        button { background-color: #ff9800; color: white; border: none; font-weight: bold; }
        button:disabled { background-color: #ccc; }
        #debug-info { margin-top: 20px; padding: 10px; background: #333; color: #0f0; font-family: monospace; font-size: 12px; border-radius: 5px; display: none; white-space: pre-wrap; word-break: break-all; }
        #result { margin-top: 15px; padding: 15px; background: #e0f2f1; border-radius: 8px; display: none; }
        img { max-width: 100%; margin-top: 10px; border-radius: 8px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h3>ğŸ” AI å¡è·¯é‡Œè¯†åˆ« (æœ€ç»ˆè°ƒè¯•)</h3>
    
    <label>API Key:</label>
    <input type="password" id="api-key" placeholder="ç²˜è´´ Key..." value="">

    <label style="margin-top:15px; display:block;">é€‰æ‹©å›¾ç‰‡:</label>
    <input type="file" id="file-upload" accept="image/*">
    <img id="preview-img" src="">

    <button id="analyze-btn">ğŸš€ è¿è¡Œè¯Šæ–­å¹¶åˆ†æ</button>

    <div id="result"></div>
    <div id="debug-info"></div>
</div>

<script>
    const fileInput = document.getElementById('file-upload');
    const previewImg = document.getElementById('preview-img');
    const analyzeBtn = document.getElementById('analyze-btn');
    const debugInfo = document.getElementById('debug-info');
    const resultDiv = document.getElementById('result');
    const apiKeyInput = document.getElementById('api-key');

    let base64Image = null;
    let mimeType = null;

    // é€‰å›¾
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewImg.style.display = "block";
            base64Image = e.target.result.split(',')[1];
            mimeType = e.target.result.split(';')[0].split(':')[1];
        };
        reader.readAsDataURL(file);
    });

    // æ ¸å¿ƒå‡½æ•°
    analyzeBtn.addEventListener('click', async function() {
        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) { alert("è¯·å¡« Key"); return; }
        if (!base64Image) { alert("è¯·é€‰å›¾"); return; }

        resultDiv.style.display = "none";
        debugInfo.style.display = "block";
        debugInfo.innerText = "â³ æ­£åœ¨åˆå§‹åŒ–...\n";
        analyzeBtn.disabled = true;

        try {
            // æ­¥éª¤ 1: å°è¯•æœ€é€šç”¨çš„ gemini-1.5-flash
            debugInfo.innerText += "1ï¸âƒ£ å°è¯•æ¨¡å‹: gemini-1.5-flash ...\n";
            await runAnalysis("gemini-1.5-flash", apiKey);

        } catch (error) {
            debugInfo.innerText += "âŒ å¤±è´¥: " + error.message + "\n\n";
            
            // æ­¥éª¤ 2: å¦‚æœå¤±è´¥ï¼Œå°è¯• gemini-1.5-pro
            try {
                debugInfo.innerText += "2ï¸âƒ£ å°è¯•æ¨¡å‹: gemini-1.5-pro ...\n";
                await runAnalysis("gemini-1.5-pro", apiKey);
            } catch (error2) {
                debugInfo.innerText += "âŒ å¤±è´¥: " + error2.message + "\n\n";

                // æ­¥éª¤ 3: ç»æ‹› - æŸ¥è¯¢å¯ç”¨æ¨¡å‹åˆ—è¡¨
                debugInfo.innerText += "3ï¸âƒ£ æ­£åœ¨æŸ¥è¯¢ä½ çš„ Key èƒ½ç”¨ä»€ä¹ˆæ¨¡å‹...\n";
                await listAvailableModels(apiKey);
            }
        } finally {
            analyzeBtn.disabled = false;
        }
    });

    async function runAnalysis(modelName, apiKey) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
        const requestBody = {
            contents: [{
                parts: [
                    { text: "åˆ†æå›¾ç‰‡ä¸­çš„é£Ÿç‰©åç§°ã€çƒ­é‡å’Œè¥å…»æˆåˆ†ã€‚" },
                    { inline_data: { mime_type: mimeType, data: base64Image } }
                ]
            }]
        };

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error.message);
        }

        const text = data.candidates[0].content.parts[0].text;
        resultDiv.innerText = "âœ… æˆåŠŸï¼\n\n" + text;
        resultDiv.style.display = "block";
        debugInfo.innerText += "ğŸ‰ æˆåŠŸè¿æ¥æ¨¡å‹ï¼š" + modelName;
    }

    async function listAvailableModels(apiKey) {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
            const data = await response.json();
            
            if (data.models) {
                const names = data.models.map(m => m.name.replace('models/', ''));
                debugInfo.innerText += "\nğŸ“‹ ä½ çš„è´¦å·å¯ç”¨æ¨¡å‹åˆ—è¡¨:\n" + names.join("\n");
                debugInfo.innerText += "\n\nâš ï¸ è¯·æˆªå›¾å‘ç»™å¼€å‘è€…ï¼Œæˆ‘ä»¬æŠŠåˆ—è¡¨é‡Œæœ‰çš„åå­—å¡«è¿›å»å°±èƒ½å¥½ï¼";
            } else {
                debugInfo.innerText += "\nâš ï¸ æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨ï¼Œå¯èƒ½æ˜¯ Key æ— æ•ˆæˆ–ç½‘ç»œé—®é¢˜ã€‚";
                debugInfo.innerText += "\nAPIè¿”å›: " + JSON.stringify(data);
            }
        } catch (e) {
            debugInfo.innerText += "\nç½‘ç»œé”™è¯¯: " + e.message;
        }
    }
</script>

</body>
</html>
