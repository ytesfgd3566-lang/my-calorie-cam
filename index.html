<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡è·¯é‡Œè¯†åˆ« (æç®€ç‰ˆ)</title>
    <style>
        body { padding: 20px; font-family: sans-serif; line-height: 1.6; }
        input, button { width: 100%; padding: 15px; margin-top: 10px; font-size: 16px; box-sizing: border-box; }
        img { max-width: 100%; margin-top: 10px; border-radius: 8px; display: none; }
        #result { background: #f0f0f0; padding: 15px; margin-top: 15px; border-radius: 8px; white-space: pre-wrap; display: none; }
        .error { color: red; background: #ffe6e6; padding: 10px; display: none; }
    </style>
</head>
<body>

    <h2>ğŸ¥— AI å¡è·¯é‡Œè¯†åˆ« (ä¿®å¤ç‰ˆ)</h2>

    <label>æ­¥éª¤1ï¼šè¾“å…¥ API Key</label>
    <input type="password" id="api-key" placeholder="ç²˜è´´ä½ çš„ Key" value="">

    <hr>

    <label>æ­¥éª¤2ï¼šç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‹ç…§/é€‰å›¾</label>
    <input type="file" id="file-upload" accept="image/*">

    <img id="preview-img" src="">

    <hr>

    <button id="analyze-btn">ğŸš€ å¼€å§‹åˆ†æ</button>

    <p id="status-text" style="color: #666;"></p>
    <div id="result"></div>
    <div id="error-box" class="error"></div>

<script>
    const fileInput = document.getElementById('file-upload');
    const previewImg = document.getElementById('preview-img');
    const analyzeBtn = document.getElementById('analyze-btn');
    const statusText = document.getElementById('status-text');
    const resultDiv = document.getElementById('result');
    const errorBox = document.getElementById('error-box');
    const apiKeyInput = document.getElementById('api-key');

    let base64Image = null;
    let mimeType = null;

    // 1. ç›‘å¬å›¾ç‰‡é€‰æ‹©
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        statusText.innerText = "æ­£åœ¨è¯»å–å›¾ç‰‡...";
        
        const reader = new FileReader();
        reader.onload = function(e) {
            // æ˜¾ç¤ºé¢„è§ˆ
            previewImg.src = e.target.result;
            previewImg.style.display = "block";
            statusText.innerText = "å›¾ç‰‡å·²å°±ç»ªï¼Œè¯·ç‚¹å‡»å¼€å§‹åˆ†æ";
            
            // å‡†å¤‡æ•°æ®
            base64Image = e.target.result.split(',')[1];
            mimeType = e.target.result.split(';')[0].split(':')[1];
        };
        reader.readAsDataURL(file);
    });

    // 2. ç‚¹å‡»åˆ†æ
    analyzeBtn.addEventListener('click', async function() {
        // æ¸…ç©ºæ—§çŠ¶æ€
        resultDiv.style.display = "none";
        errorBox.style.display = "none";

        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) {
            alert("è¯·å…ˆå¡«å†™ API Key");
            return;
        }
        if (!base64Image) {
            alert("è¯·å…ˆé€‰æ‹©ä¸€å¼ å›¾ç‰‡");
            return;
        }

        statusText.innerText = "â³ æ­£åœ¨è¯·æ±‚ AI åˆ†æï¼Œè¯·ç¨å€™...";
        analyzeBtn.disabled = true;
        analyzeBtn.innerText = "åˆ†æä¸­...";

        try {
            // ä½¿ç”¨ gemini-1.5-flashï¼Œå¦‚æœæŠ¥é”™ä¼šè‡ªåŠ¨é™çº§é€»è¾‘ä¸éœ€è¦å¤ªå¤æ‚
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            const requestBody = {
                contents: [{
                    parts: [
                        { text: "ä½ æ˜¯è¥å…»å¸ˆã€‚åˆ†æå›¾ç‰‡é£Ÿç‰©çš„ï¼š1.åç§° 2.çƒ­é‡ 3.è¥å…»æˆåˆ†(ç¢³æ°´/è›‹ç™½/è„‚è‚ª) 4.å¥åº·å»ºè®®ã€‚" },
                        { inline_data: { mime_type: mimeType, data: base64Image } }
                    ]
                }]
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();

            if (data.error) {
                throw new Error(data.error.message);
            }

            const text = data.candidates[0].content.parts[0].text;
            resultDiv.innerText = text; // æ˜¾ç¤ºç»“æœ
            resultDiv.style.display = "block";
            statusText.innerText = "âœ… åˆ†æå®Œæˆ";

        } catch (err) {
            errorBox.innerText = "å‡ºé”™äº†ï¼š" + err.message;
            errorBox.style.display = "block";
            statusText.innerText = "âŒ å¤±è´¥";
            
            // å¦‚æœæ˜¯æ¨¡å‹æ‰¾ä¸åˆ°ï¼Œæç¤ºç”¨æˆ·
            if (err.message.includes("not found")) {
                errorBox.innerText += "\n(å»ºè®®ï¼šè¯·æ£€æŸ¥ API Key æ˜¯å¦æ­£ç¡®ï¼Œæˆ–å°è¯•ç¨åå†è¯•)";
            }
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerText = "ğŸš€ å¼€å§‹åˆ†æ";
        }
    });
</script>

</body>
</html>
