<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡è·¯é‡Œè¯†åˆ« (ç¨³å®šç‰ˆ)</title>
    <style>
        body { padding: 20px; font-family: sans-serif; line-height: 1.6; background-color: #f4f4f9; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 15px; margin-top: 10px; font-size: 16px; box-sizing: border-box; border-radius: 8px; border: 1px solid #ddd; }
        button { background-color: #4CAF50; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        img { max-width: 100%; margin-top: 15px; border-radius: 8px; display: none; }
        #result { background: #e8f5e9; padding: 15px; margin-top: 15px; border-radius: 8px; white-space: pre-wrap; display: none; color: #2e7d32; }
        .error { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 8px; margin-top: 15px; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align: center; color: #333;">ğŸ¥— AI å¡è·¯é‡Œè¯†åˆ«</h2>
    
    <label>æ­¥éª¤1ï¼šè¾“å…¥ API Key</label>
    <input type="password" id="api-key" placeholder="ç²˜è´´ä½ çš„ Key" value="">

    <label style="margin-top: 20px; display:block;">æ­¥éª¤2ï¼šæ‹ç…§/é€‰å›¾</label>
    <input type="file" id="file-upload" accept="image/*">
    <img id="preview-img" src="">

    <button id="analyze-btn">ğŸš€ å¼€å§‹åˆ†æ</button>

    <p id="status-text" style="text-align: center; color: #666; margin-top: 10px;"></p>
    <div id="result"></div>
    <div id="error-box" class="error"></div>
</div>

<script>
    const fileInput = document.getElementById('file-upload');
    const previewImg = document.getElementById('preview-img');
    const analyzeBtn = document.getElementById('analyze-btn');
    const statusText = document.getElementById('status-text');
    const resultDiv = document.getElementById('result');
    const errorBox = document.getElementById('error-box');
    const apiKeyInput = document.getElementById('api-key');

    let base64Image = null;
    let mimeType = null;

    // å›¾ç‰‡å¤„ç†
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            previewImg.src = e.target.result;
            previewImg.style.display = "block";
            base64Image = e.target.result.split(',')[1];
            mimeType = e.target.result.split(';')[0].split(':')[1];
            statusText.innerText = "å›¾ç‰‡å·²å‡†å¤‡å¥½";
        };
        reader.readAsDataURL(file);
    });

    // æ ¸å¿ƒåˆ†æé€»è¾‘
    analyzeBtn.addEventListener('click', async function() {
        resultDiv.style.display = "none";
        errorBox.style.display = "none";

        const apiKey = apiKeyInput.value.trim();
        if (!apiKey) { alert("è¯·å¡«å…¥ API Key"); return; }
        if (!base64Image) { alert("è¯·å…ˆé€‰å›¾"); return; }

        statusText.innerText = "æ­£åœ¨å°è¯•è¿æ¥ AI (æ¨¡å‹ 1)...";
        analyzeBtn.disabled = true;

        // å®šä¹‰ä¸¤ä¸ªæ¨¡å‹ï¼šé¦–é€‰ Flash-002ï¼Œå¤‡ç”¨ Pro
        const models = ['gemini-1.5-flash-002', 'gemini-pro'];
        
        let success = false;
        let lastError = "";

        // å¾ªç¯å°è¯•æ¨¡å‹
        for (const modelName of models) {
            try {
                if(modelName === 'gemini-pro') statusText.innerText = "æ¨¡å‹1å¿™ç¢Œï¼Œæ­£åœ¨åˆ‡æ¢å¤‡ç”¨æ¨¡å‹...";

                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                
                const requestBody = {
                    contents: [{
                        parts: [
                            { text: "ä½ æ˜¯è¥å…»å¸ˆã€‚åˆ†æå›¾ç‰‡é£Ÿç‰©çš„ï¼š1.åç§° 2.çƒ­é‡ 3.è¥å…»æˆåˆ†(ç¢³æ°´/è›‹ç™½/è„‚è‚ª) 4.å¥åº·å»ºè®®ã€‚" },
                            { inline_data: { mime_type: mimeType, data: base64Image } }
                        ]
                    }]
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error.message);

                // æˆåŠŸï¼
                const text = data.candidates[0].content.parts[0].text;
                resultDiv.innerText = text;
                resultDiv.style.display = "block";
                statusText.innerText = "âœ… åˆ†ææˆåŠŸï¼";
                success = true;
                break; // è·³å‡ºå¾ªç¯

            } catch (err) {
                console.error(`${modelName} å¤±è´¥:`, err);
                lastError = err.message;
            }
        }

        if (!success) {
            errorBox.innerText = "æ‰€æœ‰æ¨¡å‹å°è¯•å‡å¤±è´¥ã€‚\né”™è¯¯è¯¦æƒ…: " + lastError;
            errorBox.style.display = "block";
            statusText.innerText = "âŒ å¤±è´¥";
        }

        analyzeBtn.disabled = false;
    });
</script>

</body>
</html>
